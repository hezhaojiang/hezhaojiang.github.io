<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201006232605.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201006232538.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Bree+Serif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.hezhaojiang.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"buttons","active":true,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="文章 音视频封装 - TS 封装格式 中分析了 TS 流的结构，本文通过一段真实的码流的分析来加强对 TS 流结构的理解。  注 1：本文中的 TS 码流截取自一段从网络下载的网络视频">
<meta property="og:type" content="article">
<meta property="og:title" content="音视频封装 - TS 封装解析示例">
<meta property="og:url" content="http://github.hezhaojiang.io/post/2020/a03a01c2/index.html">
<meta property="og:site_name" content="何照江的博客">
<meta property="og:description" content="文章 音视频封装 - TS 封装格式 中分析了 TS 流的结构，本文通过一段真实的码流的分析来加强对 TS 流结构的理解。  注 1：本文中的 TS 码流截取自一段从网络下载的网络视频">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128145341.png">
<meta property="og:image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128155219.png">
<meta property="og:image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128163234.png">
<meta property="og:image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128192950.png">
<meta property="article:published_time" content="2020-11-27T08:13:10.000Z">
<meta property="article:modified_time" content="2021-11-07T11:28:11.400Z">
<meta property="article:author" content="何照江">
<meta property="article:tag" content="MPEG2-TS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128145341.png">


<link rel="canonical" href="http://github.hezhaojiang.io/post/2020/a03a01c2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://github.hezhaojiang.io/post/2020/a03a01c2/","path":"post/2020/a03a01c2/","title":"音视频封装 - TS 封装解析示例"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>音视频封装 - TS 封装解析示例 | 何照江的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="何照江的博客" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">何照江的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li> 
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#pat-%E5%8C%85%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">PAT 包解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pmt-%E5%8C%85%E8%A7%A3%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">PMT 包解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E5%8C%85%E8%A7%A3%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">视频包解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9F%B3%E9%A2%91%E5%8C%85%E8%A7%A3%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">音频包解析</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="何照江"
      src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20200801192913.jpg">
  <p class="site-author-name" itemprop="name">何照江</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hezhaojiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hezhaojiang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hezhaojiang" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://github.hezhaojiang.io/post/2020/a03a01c2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20200801192913.jpg">
      <meta itemprop="name" content="何照江">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何照江的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          音视频封装 - TS 封装解析示例
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-27 16:13:10" itemprop="dateCreated datePublished" datetime="2020-11-27T16:13:10+08:00">2020-11-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-07 19:28:11" itemprop="dateModified" datetime="2021-11-07T19:28:11+08:00">2021-11-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%B0%81%E8%A3%85/" itemprop="url" rel="index"><span itemprop="name">音视频封装</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>文章 <a href="/post/2020/c6ae0d94/" title="音视频封装 - TS 封装格式">音视频封装 - TS 封装格式</a> 中分析了 <code>TS</code> 流的结构，本文通过一段真实的码流的分析来加强对 <code>TS</code> 流结构的理解。</p>
<blockquote>
<p>注 1：本文中的 <code>TS</code> 码流截取自一段从网络下载的网络视频</p>
</blockquote>
<span id="more"></span>
<h2 id="pat-包解析">PAT 包解析</h2>
<p>该段码流中第一包并不是 <code>PAT</code> 包，而 TS 封装的解析需要从 <code>PAT</code> 包开始，所以我们向后寻找 PID 为 0 的第一包，该段码流中第二包 PID 为 0，是一个 <code>PAT</code> 包：</p>
<figure>
<img data-src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128145341.png" alt="Packet 2" /><figcaption aria-hidden="true">Packet 2</figcaption>
</figure>
<p>第一部分：<code>TS</code> 包头</p>
<pre><code>HEX 47       40       00       10
BIN 01000111 01000000 00000000 00010000</code></pre>
<p>对比该部分结构，可代码定义如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_HEAD</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> sync_byte                    <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 同步字节，固定为 0x47</span>
    <span class="token keyword">unsigned</span> transport_error_indicator    <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 传输错误指示符，0 表明在 TS 头的 adapt 域后没有无用字节</span>
    <span class="token keyword">unsigned</span> payload_unit_start_indicator <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 负载单元起始标示符，一个完整的数据包开始时标记为 1</span>
    <span class="token keyword">unsigned</span> transport_priority           <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 传输优先级，0 为低优先级</span>
    <span class="token keyword">unsigned</span> pid                          <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// PID 值，0 表示 TS 头后面就是 PAT 表</span>
    <span class="token keyword">unsigned</span> transport_scrambling_controls    <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// TS 流 ID，一般为 0x0001，区别于一个网络中其它多路复用的流</span>
    <span class="token keyword">unsigned</span> adaptation_field_control         <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 是否包含自适应区，'01'为无自适应域，仅含有效负载</span>
    <span class="token keyword">unsigned</span> continuity_counter               <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 递增计数器，0-F，起始值不一定取 0，但必须是连续的</span>
<span class="token punctuation">&#125;</span> TS_HEAD<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二部分：<code>TS</code> 包调整字节</p>
<pre><code>HEX 00
BIN 00000000</code></pre>
<p>对比该部分结构，代码定义分析如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_ADAPT</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> adaptation_field_length<span class="token punctuation">;</span>  <span class="token comment">// 自适应域长度，后面的字节数，此包中为 7 字节</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flag<span class="token punctuation">;</span>                     <span class="token comment">// 0x50 表示包含 PCR，0x40 表示不包含 PCR</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> PCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 节目时钟参考 40bit</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> stuffing_bytes<span class="token punctuation">;</span>   <span class="token comment">// 填充字节，取值 0xFF</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>adaptation_field_length</code> 为 <code>0</code>，故该部分后续字节数为 <code>0</code>。</p>
<p>第三部分：<code>TS</code> 包有效载荷 - 即 <code>PSI</code> 表 <code>PAT</code> 的数据：</p>
<pre><code>HEX 00 B0 0D 00 01 C1 00 00  00 01 F0 00 2A B1 04 B2
BIN 00000000 10110000 00001101 00000000 00000001 11000001 00000000 00000000
    00000000 00000001 11110000 00000000 00101010 10110001 00000100 10110010</code></pre>
<p>对比该部分结构，代码定义分析如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_PAT</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> table_id                     <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 固定 0x00 ，标志是该表是 PAT</span>
    <span class="token keyword">unsigned</span> section_syntax_indicator     <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 段语法标志位，固定为 1</span>
    <span class="token keyword">unsigned</span> zero                         <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span>
    <span class="token keyword">unsigned</span> reserved_1                   <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 11</span>
    <span class="token keyword">unsigned</span> section_length               <span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// 段长度，0000 00001101 值为 13</span>
    <span class="token keyword">unsigned</span> transport_stream_id          <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// TS 流 ID，一般为 0x0001，区别于一个网络中其它多路复用的流</span>
    <span class="token keyword">unsigned</span> reserved_2                   <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 11</span>
    <span class="token keyword">unsigned</span> version_number               <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// PAT 版本号，固定为 00000，如果 PAT 有变化则版本号加 1</span>
    <span class="token keyword">unsigned</span> current_next_indicator       <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 固定为 1，表示这个 PAT 表有效，如果为 0 则要等待下一个 PAT 表</span>
    <span class="token keyword">unsigned</span> section_number               <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 分段的号码。PAT 可能分为多段传输，第一段为 00，以后每个分段加 1，最多可能有 256 个分段</span>
    <span class="token keyword">unsigned</span> last_section_number          <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 最后一个分段的号码</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>TS_PAT_Program<span class="token operator">></span> program<span class="token punctuation">;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 该包中仅有一个 TS_PAT_Program</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">unsigned</span> program_number       <span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">;</span>  <span class="token comment">// 节目号，为 0x0000 时表示这是 NIT，节目号为 0x0001 时, 表示这是 PMT</span>
            <span class="token keyword">unsigned</span> reserved             <span class="token operator">:</span><span class="token number">3</span>    <span class="token comment">// 保留，固定为 111</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>program_number <span class="token operator">==</span> <span class="token number">0x0000</span><span class="token punctuation">)</span>
                <span class="token keyword">unsigned</span> network_PID      <span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>program_number <span class="token operator">==</span> <span class="token number">0x0001</span><span class="token punctuation">)</span>
                <span class="token keyword">unsigned</span> program_map_PID  <span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span>  <span class="token comment">// 节目号对应内容的 PID 值，该 PAT 包取值为 0x1000 = 4096</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> CRC_32                       <span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">// CRC32 校验码</span>
<span class="token punctuation">&#125;</span> TS_PAT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="pmt-包解析">PMT 包解析</h2>
<p><code>PAT</code> 信息中可知 <code>PMT</code> 表的 <code>PID</code> 为 <code>4096</code>，我们向后寻找 <code>PID</code> 为 <code>4096</code> 的 <code>TS</code> 包，发现第 <code>3</code> 包 <code>TS</code> 包即为 <code>PMT</code> 包：</p>
<figure>
<img data-src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128155219.png" alt="PMT" /><figcaption aria-hidden="true">PMT</figcaption>
</figure>
<p>第一部分：<code>TS</code> 包头</p>
<pre><code>HEX 47       50       00       10
BIN 01000111 01010000 00000000 00010000</code></pre>
<p>从 <code>TS</code> 包头可知该 <code>TS</code> 包的 <code>PID</code> 值为 <code>4096</code>，是我们寻找的 <code>PMT</code> 包。</p>
<p>第二部分：<code>TS</code> 包调整字节，该部分只有一个字节 <code>0x00</code>，详见上文解析，此处不再重复。</p>
<p>第三部分：<code>TS</code> 包有效载荷 - <code>PMT</code></p>
<pre><code>HEX 02 B0 23 00 01 C1 00 00  E1 00 F0 00 24 E1 00 F0
    06 05 04 48 45 56 43 03  E1 01 F0 06 0A 04 75 6E
    64 00 DD 33 FC 6A
BIN 00000010 10110000 00100011 00000000 00000001 11000001 00000000 00000000
    11100001 00000000 11110000 00000000 00100100 11100001 00000000 11110000
    00000110 00000101 00000100 01001000 01000101 01010110 01000011 00000011
    11100001 00000001 11110000 00000110 00001010 00000100 01110101 01101110
    01100100 00000000 11011101 00110011 11111100 01101010</code></pre>
<p>对比该部分结构，代码定义分析如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_PMT</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> table_id                     <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 取值随意，一般使用 0x02, 表示 PMT 表</span>
    <span class="token keyword">unsigned</span> section_syntax_indicator     <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 段语法标志位，固定为 1</span>
    <span class="token keyword">unsigned</span> zero                         <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 0</span>
    <span class="token keyword">unsigned</span> reserved_1                   <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 11</span>
    <span class="token keyword">unsigned</span> section_length               <span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// 段长度，0000 00100011 = 35 字节</span>
    <span class="token keyword">unsigned</span> program_number               <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// 当前 PMT 表映射到的节目号，1、2、3</span>
    <span class="token keyword">unsigned</span> reserved_2                   <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 11</span>
    <span class="token keyword">unsigned</span> version_number               <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// PMT 版本号码，固定为 00000，如果 PAT 有变化则版本号加 1</span>
    <span class="token keyword">unsigned</span> current_next_indicator       <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 发送的 PMT 表， 1 当前有效 PMT 有效</span>
    <span class="token keyword">unsigned</span> section_number               <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 分段的号码。PMT 可能分为多段传输，第一段为 00，以后每个分段加 1，最多可能有 256 个分段</span>
    <span class="token keyword">unsigned</span> last_section_number          <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 分段数</span>
    <span class="token keyword">unsigned</span> reserved_3                   <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 111</span>
    <span class="token keyword">unsigned</span> PCR_PID                      <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// 指明 TS 包的 PID 值 (0x0100 = 256)，该 TS 包含有 PCR 同步时钟，</span>
    <span class="token keyword">unsigned</span> reserved_4                   <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 预留位，固定为 1111</span>
    <span class="token keyword">unsigned</span> program_info_length          <span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// 前 2bit 为 00，该域指出跟随其后对节目信息的描述的字节数 (0x000 = 0)。</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> descriptor<span class="token punctuation">;</span>      <span class="token comment">// 0 字节</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>TS_PMT_Stream<span class="token operator">></span> PMT_Stream <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">unsigned</span> stream_type          <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 指示本节目流的类型，H.265 编码对应 0x24</span>
            <span class="token keyword">unsigned</span> reserved1            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 111</span>
            <span class="token keyword">unsigned</span> elementary_PID       <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// 指示该流的 PID 值 (0x100 = 256)</span>
            <span class="token keyword">unsigned</span> reserved2            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1111</span>
            <span class="token keyword">unsigned</span> ES_info_length       <span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// 前两位 bit 为 00，指示跟随其后的描述相关节目元素的字节数 (0x006 = 6)</span>
            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> descriptor<span class="token punctuation">;</span>   <span class="token comment">// 6 字节</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">unsigned</span> stream_type          <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// 指示本节目流的类型，MP3 编码对应 0x03</span>
            <span class="token keyword">unsigned</span> reserved1            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 111</span>
            <span class="token keyword">unsigned</span> elementary_PID       <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">// 指示该流的 PID 值 (0x101 = 257)</span>
            <span class="token keyword">unsigned</span> reserved2            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1111</span>
            <span class="token keyword">unsigned</span> ES_info_length       <span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">// 前两位 bit 为 00，指示跟随其后的描述相关节目元素的字节数 (0x006 = 6)</span>
            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> descriptor<span class="token punctuation">;</span>   <span class="token comment">// 6 字节</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> CRC_32                       <span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">// CRC32 校验码</span>
<span class="token punctuation">&#125;</span> TS_PMT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>PMT</code> 是定义每路节目的音视频类型 <code>TYPE</code> 和编号 <code>PID</code> 的关键，该 <code>TS</code> 码流中： - 视频流格式为 <code>H.265</code>，对应 <code>PID</code> 为 <code>256</code> - 视频流格式为 <code>MP3</code>，对应 <code>PID</code> 为 <code>257</code></p>
<h2 id="视频包解析">视频包解析</h2>
<p>第 <code>4</code> 包的 <code>PID</code> 值为 <code>256</code>，根据上述分析可知，该包为一个视频包：</p>
<figure>
<img data-src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128163234.png" alt="视频包" /><figcaption aria-hidden="true">视频包</figcaption>
</figure>
<p>第一部分：<code>TS</code> 包头</p>
<pre><code>HEX 47       41       00       30
BIN 01000111 01000001 00000000 00110000</code></pre>
<p>从 <code>TS</code> 包头可知该 <code>TS</code> 包的 <code>PID</code> 值为 <code>256</code>，是我们寻找的视频包，另外，TS 包头中 <code>adaptation_field_control</code> 字段为 <code>11</code>，代表同时带有自适应域和有效负载。</p>
<p>第二部分：<code>TS</code> 包调整字节</p>
<pre><code>HEX 07 50 00 00 7C F7 7E 00
BIN 00000111 01010000 00000000 00000000 01111100 11110111 01111110 00000000</code></pre>
<p>对比该部分结构，代码定义分析如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_ADAPT</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> adaptation_field_length<span class="token punctuation">;</span>  <span class="token comment">// 自适应域长度，后面的字节数，此包中为 7 字节</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flag<span class="token punctuation">;</span>                     <span class="token comment">// 0x50 表示包含 PCR</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> PCR<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 节目时钟参考 40bit</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> stuffing_bytes<span class="token punctuation">;</span>   <span class="token comment">// 填充字节，取值 0xFF</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三部分：<code>TS</code> 包有效载荷 - <code>PES</code></p>
<pre><code>HEX 00 00 01 E0 00 00 80 80  05 21 00 07 E0 0D
BIN 00000000 00000000 00000001 11100000 00000000 00000000 10000000 10000000
    00000101 00100001 00000000 00000111 11100000 00001101</code></pre>
<p>对比该部分结构，代码定义分析如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">TS_ADAPT</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> start_code_prefix        <span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">;</span> <span class="token comment">// 包头起始码，固定为 0x000001</span>
    <span class="token keyword">unsigned</span> stream_id<span class="token punctuation">;</span>               <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// PES 包中的负载流类型，一般视频为 0xe0，音频为 0xc0</span>
    <span class="token keyword">unsigned</span> PES_packet_length        <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// PES 包长度，包括此字节后的可选包头和负载的长度</span>
    <span class="token keyword">unsigned</span> reserved_1               <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 10</span>
    <span class="token keyword">unsigned</span> PES_scrambling_control   <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 加密模式，00 未加密，01 或 10 或 11 由用户定义</span>
    <span class="token keyword">unsigned</span> PES_priority             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 有效负载的优先级，值为 1 比值为 0 的负载优先级高</span>
    <span class="token keyword">unsigned</span> Data_alignment_indicator <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 数据定位指示器</span>
    <span class="token keyword">unsigned</span> Copyright                <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 版权信息，1 为有版权，0 无版权</span>
    <span class="token keyword">unsigned</span> Original_or_copy         <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 原始或备份，1 为原始，0 为备份</span>
    <span class="token keyword">unsigned</span> PTS_DTS_flags            <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// PTS 和 DTS 标志位，10 表示首部有 PTS 字段，11 表示有 PTS 和 DTS 字段，00 表示都没有，01 被禁止</span>
    <span class="token keyword">unsigned</span> ESCR_flag                <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// ESCR 标志，1 表示首部有 ESCR 字段，0 则无此字段</span>
    <span class="token keyword">unsigned</span> ES_rate_flag             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// ES_rate 字段，1 表示首部有此字段，0 无此字段</span>
    <span class="token keyword">unsigned</span> DSM_trick_mode_flag      <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 表示有 8 位的 DSM_trick_mode_flag 字段，0 无此字段</span>
    <span class="token keyword">unsigned</span> Additional_copy_info_flag<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 表示首部有此字段，0 表示无此字段</span>
    <span class="token keyword">unsigned</span> PES_CRC_flag             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 1 表示 PES 分组有 CRC 字段，0 无此字段</span>
    <span class="token keyword">unsigned</span> PES_extension_flag       <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 扩展标志位，置 1 表示有扩展字段，0 无此字段</span>
    <span class="token keyword">unsigned</span> PES_header_data_length   <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">;</span>  <span class="token comment">// PES 首部中可选字段和填充字段的长度，可选字段的内容由上面 7 个 flags 来进行控制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PTS_DTS_flags <span class="token operator">==</span> <span class="token string">'10'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> reserved_1           <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 0010</span>
        <span class="token keyword">unsigned</span> PTS_32_30            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_1             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> PTS_29_15            <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_2             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> PTS_14_0             <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_3             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PTS_DTS_flags <span class="token operator">==</span> <span class="token string">'11'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> reserved_1           <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 0011</span>
        <span class="token keyword">unsigned</span> PTS_32_30            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_1             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> PTS_29_15            <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_2             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> PTS_14_0             <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// PTS</span>
        <span class="token keyword">unsigned</span> marker_3             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> reserved_2           <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 0001</span>
        <span class="token keyword">unsigned</span> DTS_32_30            <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// DTS</span>
        <span class="token keyword">unsigned</span> marker_1             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> DTS_29_15            <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// DTS</span>
        <span class="token keyword">unsigned</span> marker_2             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
        <span class="token keyword">unsigned</span> DTS_14_0             <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// DTS</span>
        <span class="token keyword">unsigned</span> marker_3             <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 保留位，固定为 1</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ESCR_flag<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ES_rate_flag<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PES_extension_flag<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> stuffing_bytes<span class="token punctuation">;</span>   <span class="token comment">// 填充字段，固定为 0xFF，不得超过 32 字节</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">></span> PES_packet_data_byte <span class="token comment">// PES 包的负载数据</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对比代码和码流数据，发现码流中 <code>PES_packet_length</code> 值为 <code>0</code>，其表示 <code>PES</code> 分组长度要么没有规定要么没有限制。这种情况只允许出现在有效负载包含来源于传输流分组中某个视频基本流的字节的 <code>PES</code> 分组中。</p>
<p>该段视频流中 <code>PTS_DTS_flags == '10'</code>，故其还有 <code>5</code> 字节的 <code>PTS</code> 信息，我们尝试解析 <code>PTS</code> 信息：</p>
<ol type="1">
<li><code>PTS</code> 的 <code>5</code> 字节信息为 <code>21 00 07 E0 0D</code>，对应二进制 <code>00100001 00000000 00000111 11100000 00001101</code></li>
<li>除去 <code>reserved</code> 和 <code>marker</code> 字段为 <code>000 00000000 0000011 11100000 0000110</code></li>
<li>整理可得 <code>0 00000000 00000001 11110000 00000110</code>，即 <code>0x001F006</code></li>
<li>转为十进制为 <code>126982</code>，与工具计算结果一致</li>
</ol>
<p><code>PES</code> 包头数据分析完，剩下的数据就是帧视频数据的一部分了。</p>
<h2 id="音频包解析">音频包解析</h2>
<p>音频包与视频包均使用 <code>PES</code> 格式封装，解析方式基本一致，比如：</p>
<figure>
<img data-src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20201128192950.png" alt="音频包" /><figcaption aria-hidden="true">音频包</figcaption>
</figure>
<p>音频包中第三部分：<code>TS</code> 包有效载荷 - <code>PES</code></p>
<pre><code>HEX 00 00 01 C0 09 D3 80 80 05 21 00 07 D8 61 FF
BIN 00000000 00000000 00000001 11000000 00001001 11010011 10000000 10000000
    00000101 00100001 00000000 00000111 11011000 01010001 11111111</code></pre>
<p>该段视频流中 <code>PTS_DTS_flags == '10'</code>，故其也有 <code>5</code> 字节的 <code>PTS</code> 信息，我们尝试解析 <code>PTS</code> 信息：</p>
<ol type="1">
<li><code>PTS</code> 的 <code>5</code> 字节信息为 <code>21 00 07 D8 61</code>，对应二进制 <code>00100001 00000000 00000111 11011000 01100001</code></li>
<li>除去 <code>reserved</code> 和 <code>marker</code> 字段为 <code>000 00000000 0000011 11011000 0110000</code></li>
<li>整理可得 <code>0 00000000 00000001 11101100 00110000</code>，即 <code>0x001EC30</code></li>
<li>转为十进制为 <code>126000</code>，与工具计算结果一致</li>
</ol>
<p><code>PES</code> 包头数据分析完，剩下的数据就音频数据的一部分了。</p>
<ul>
<li>[1] <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1746983">音视频封装：MPTG2-TS 媒体封装实例解析和说明 - 云 + 社区 - 腾讯云</a></li>
<li>[2] <a href="/post/2020/c6ae0d94/" title="音视频封装 - TS 封装格式">音视频封装 - TS 封装格式</a></li>
<li>[3] <a target="_blank" rel="noopener" href="https://github.com/daniep01/MPEG-2-Transport-Stream-Packet-Analyser">daniep01/MPEG-2-Transport-Stream-Packet-Analyser: MPEG-2 Transport Stream packet analyser...</a></li>
<li>[4] 文中 <code>TS</code> 码流视频源文件：<a href="/slave/TS/TestVideoTS.7z" title="密码：github.com">点击下载</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20200904003518.png" alt="何照江 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="https://gitee.com/hezhaojiang/MyPics/raw/master/img/20200904003437.png" alt="何照江 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/MPEG2-TS/" rel="tag"># MPEG2-TS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/2020/c6ae0d94/" rel="prev" title="音视频封装 - TS 封装格式">
                  <i class="fa fa-chevron-left"></i> 音视频封装 - TS 封装格式
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/2020/e90af351/" rel="next" title="音视频封装 - MP4 封装格式">
                  音视频封装 - MP4 封装格式 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">何照江</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>

<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"dark","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js","integrity":"sha256-blHXaX2RMvNwEOnrYOl/6/RKqNi97Ig3o6Ae3bhXPvM="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://github.hezhaojiang.io/post/2020/a03a01c2/"}</script>
  <script src="/js/third-party/quicklink.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
<script type="text/javascript" src="/js/click_magic.js"></script>
