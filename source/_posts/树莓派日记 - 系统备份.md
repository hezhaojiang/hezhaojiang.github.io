---
title: 树莓派日记 - 系统备份
categories:
  - 树莓派日记
abbrlink: 4fd2fc4f
date: 2020-10-18 14:22:40
---
在树莓派 Linux 环境折腾过程中，由于 Linux 系统开放的权限比较高，以 root 权限操作的话很有可能就会误删一些系统文件导致系统崩溃。我手里树莓派的系统搞挂过好几次，每次只能重新刷入镜像，开机后还得重复一大堆操作，所以备份树莓派的系统就很重要了。还可以把已经部署好的树莓派系统，批量复制到更多的树莓派上。

<!-- more -->

{% note danger no-icon %}

## 写在前面

本文采用 kallsbo 大神提供的树莓派备份工具 BASH-RaspberryPI-System-Backup

注意：该备份工具采用的备份方式为==全卡备份==，备份速度慢，效率低，不建议使用，本文后续还会更新其他备份方式

Github 地址：<https://github.com/kallsbo/BASH-RaspberryPI-System-Backup>

工具主页：<https://hackviking.com/2017/09/25/automated-raspberry-pi-backup-complete-image/>

{% endnote %}

## 准备工作

1. 需要一个 nas 系统挂载到树莓派设备上，可以用带 nas 功能的路由器，我手里正好有一个海康云盘，带有 nas 功能。
2. 设置开机自动挂载 nas 到文件夹 `/mnt/backup`

### 创建文件夹

``` bash
sudo mkdir /mnt/backup
```

### 添加 fstab

修改文件 `/etc/fstab/`，在文件末尾增加以下内容：

``` linux
//192.168.123.68/Disk1share/Backup/raspberrypi_boot /mnt/backup cifs  username=admin,password=Abc12345 0 0
```

### 测试挂载

``` bash
## 执行 fstab 挂载
sudo mount -a
## 查看是否挂载成功
mount
```

### 挂载过程中遇到了一些问题

#### bad option for several filesystems

根据需要挂载的文件系统类型，可能需要安装以下依赖：

``` bash
## for cifs
sudo apt install -y cifs-utils
## for nfs
sudo apt install -y  nfs-common
```

#### mount.cifs: bad UNC

1. 检查用户名密码以及格式是否输入正确
    - 正确格式示范：username=admin,password=Abc12345
2. 检查挂载地址 URL 格式是否正确
    - IP 前带有两个斜杠 '//'
    - IP 后不要有冒号
    - 目录中避免出现反斜杠 '\'
    - 正确 URL 示范：//192.168.123.68/Disk1share/Backup/raspberrypi_boot

## 安装工具

``` bash
wget https://github.com/kallsbo/BASH-RaspberryPI-System-Backup/raw/master/system_backup.sh
chmod +x system_backup.sh
```

## 设置自动备份

``` bash
crontab -e
```

增加以下内容：

``` linux
## This will make the script take a full image backup every night at 3 am.
0 3 * * * /mnt/backup/system_backup.sh
```
